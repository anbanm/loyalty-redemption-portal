<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">

    <!-- Initial Database Schema -->
    <changeSet id="001-create-company-table" author="loyalty-portal">
        <createTable tableName="company">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="loyalty_account_id" type="varchar(100)">
                <constraints unique="true"/>
            </column>
            <column name="tier_level" type="varchar(50)"/>
            <column name="is_active" type="boolean" defaultValueBoolean="true"/>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <createIndex tableName="company" indexName="idx_company_loyalty_account_id">
            <column name="loyalty_account_id"/>
        </createIndex>
        <createIndex tableName="company" indexName="idx_company_active">
            <column name="is_active"/>
        </createIndex>
    </changeSet>

    <changeSet id="002-create-account-manager-table" author="loyalty-portal">
        <createTable tableName="account_manager">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="company_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="role" type="varchar(50)" defaultValue="ACCOUNT_MANAGER"/>
            <column name="is_active" type="boolean" defaultValueBoolean="true"/>
            <column name="last_login" type="timestamp"/>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="account_manager" baseColumnNames="company_id"
                                constraintName="fk_account_manager_company"
                                referencedTableName="company" referencedColumnNames="id"/>
        <createIndex tableName="account_manager" indexName="idx_account_manager_email">
            <column name="email"/>
        </createIndex>
        <createIndex tableName="account_manager" indexName="idx_account_manager_company_active">
            <column name="company_id"/>
            <column name="is_active"/>
        </createIndex>
    </changeSet>

    <changeSet id="003-create-product-table" author="loyalty-portal">
        <createTable tableName="product">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="sku" type="varchar(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="text"/>
            <column name="product_type" type="varchar(20)">
                <constraints nullable="false"/>
            </column>
            <column name="points_cost" type="integer">
                <constraints nullable="false"/>
            </column>
            <column name="retail_price" type="decimal(10,2)"/>
            <column name="image_url" type="varchar(500)"/>
            <column name="category" type="varchar(100)"/>
            <column name="brand" type="varchar(100)"/>
            <column name="weight_kg" type="decimal(8,3)"/>
            <column name="dimensions" type="varchar(255)"/>
            <column name="is_active" type="boolean" defaultValueBoolean="true"/>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <createIndex tableName="product" indexName="idx_product_sku">
            <column name="sku"/>
        </createIndex>
        <createIndex tableName="product" indexName="idx_product_active_type">
            <column name="is_active"/>
            <column name="product_type"/>
        </createIndex>
        <createIndex tableName="product" indexName="idx_product_category">
            <column name="category"/>
        </createIndex>
    </changeSet>

    <changeSet id="004-create-inventory-table" author="loyalty-portal">
        <createTable tableName="inventory">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="product_id" type="uuid">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="quantity_available" type="integer">
                <constraints nullable="false"/>
            </column>
            <column name="quantity_reserved" type="integer" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="reorder_point" type="integer"/>
            <column name="max_quantity" type="integer"/>
            <column name="last_updated" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="inventory" baseColumnNames="product_id"
                                constraintName="fk_inventory_product"
                                referencedTableName="product" referencedColumnNames="id"/>
        <createIndex tableName="inventory" indexName="idx_inventory_available">
            <column name="quantity_available"/>
        </createIndex>
    </changeSet>

    <changeSet id="005-create-redemption-order-table" author="loyalty-portal">
        <createTable tableName="redemption_order">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="order_number" type="varchar(50)">
                <constraints unique="true"/>
            </column>
            <column name="company_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="account_manager_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="total_points" type="integer">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="varchar(50)" defaultValue="PENDING"/>
            <column name="shipping_address" type="text"/>
            <column name="special_instructions" type="text"/>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="completed_at" type="timestamp"/>
            <column name="cancelled_at" type="timestamp"/>
            <column name="cancellation_reason" type="varchar(255)"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="redemption_order" baseColumnNames="company_id"
                                constraintName="fk_redemption_order_company"
                                referencedTableName="company" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="redemption_order" baseColumnNames="account_manager_id"
                                constraintName="fk_redemption_order_account_manager"
                                referencedTableName="account_manager" referencedColumnNames="id"/>
        <createIndex tableName="redemption_order" indexName="idx_redemption_order_number">
            <column name="order_number"/>
        </createIndex>
        <createIndex tableName="redemption_order" indexName="idx_redemption_order_status">
            <column name="status"/>
        </createIndex>
        <createIndex tableName="redemption_order" indexName="idx_redemption_order_created">
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="006-create-order-item-table" author="loyalty-portal">
        <createTable tableName="order_item">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="order_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="product_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="integer">
                <constraints nullable="false"/>
            </column>
            <column name="points_per_item" type="integer">
                <constraints nullable="false"/>
            </column>
            <column name="fulfillment_status" type="varchar(50)" defaultValue="PENDING"/>
            <column name="fulfillment_reference" type="varchar(255)"/>
            <column name="tracking_number" type="varchar(100)"/>
            <column name="delivered_at" type="timestamp"/>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="order_item" baseColumnNames="order_id"
                                constraintName="fk_order_item_order"
                                referencedTableName="redemption_order" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="order_item" baseColumnNames="product_id"
                                constraintName="fk_order_item_product"
                                referencedTableName="product" referencedColumnNames="id"/>
        <createIndex tableName="order_item" indexName="idx_order_item_fulfillment_status">
            <column name="fulfillment_status"/>
        </createIndex>
        <createIndex tableName="order_item" indexName="idx_order_item_tracking">
            <column name="tracking_number"/>
        </createIndex>
    </changeSet>

    <changeSet id="007-create-loyalty-transaction-table" author="loyalty-portal">
        <createTable tableName="loyalty_transaction">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="order_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="company_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="points_amount" type="integer">
                <constraints nullable="false"/>
            </column>
            <column name="transaction_type" type="varchar(20)">
                <constraints nullable="false"/>
            </column>
            <column name="external_transaction_id" type="varchar(100)"/>
            <column name="status" type="varchar(50)" defaultValue="PENDING"/>
            <column name="error_message" type="text"/>
            <column name="retry_count" type="integer" defaultValueNumeric="0"/>
            <column name="processed_at" type="timestamp"/>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="loyalty_transaction" baseColumnNames="order_id"
                                constraintName="fk_loyalty_transaction_order"
                                referencedTableName="redemption_order" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="loyalty_transaction" baseColumnNames="company_id"
                                constraintName="fk_loyalty_transaction_company"
                                referencedTableName="company" referencedColumnNames="id"/>
        <createIndex tableName="loyalty_transaction" indexName="idx_loyalty_transaction_external_id">
            <column name="external_transaction_id"/>
        </createIndex>
        <createIndex tableName="loyalty_transaction" indexName="idx_loyalty_transaction_status">
            <column name="status"/>
        </createIndex>
        <createIndex tableName="loyalty_transaction" indexName="idx_loyalty_transaction_retry">
            <column name="status"/>
            <column name="retry_count"/>
        </createIndex>
    </changeSet>

    <!-- Sample Data for Development -->
    <changeSet id="008-insert-sample-data" author="loyalty-portal" context="development">
        <insert tableName="company">
            <column name="id" value="550e8400-e29b-41d4-a716-446655440001"/>
            <column name="name" value="Acme Corporation"/>
            <column name="loyalty_account_id" value="ACME001"/>
            <column name="tier_level" value="GOLD"/>
        </insert>
        <insert tableName="company">
            <column name="id" value="550e8400-e29b-41d4-a716-446655440002"/>
            <column name="name" value="Global Solutions Inc"/>
            <column name="loyalty_account_id" value="GLOBAL002"/>
            <column name="tier_level" value="SILVER"/>
        </insert>

        <insert tableName="account_manager">
            <column name="id" value="550e8400-e29b-41d4-a716-446655440011"/>
            <column name="company_id" value="550e8400-e29b-41d4-a716-446655440001"/>
            <column name="email" value="john.doe@acme.com"/>
            <column name="name" value="John Doe"/>
        </insert>
        <insert tableName="account_manager">
            <column name="id" value="550e8400-e29b-41d4-a716-446655440012"/>
            <column name="company_id" value="550e8400-e29b-41d4-a716-446655440002"/>
            <column name="email" value="jane.smith@global.com"/>
            <column name="name" value="Jane Smith"/>
        </insert>

        <insert tableName="product">
            <column name="id" value="550e8400-e29b-41d4-a716-446655440021"/>
            <column name="sku" value="LAPTOP-001"/>
            <column name="name" value="Premium Business Laptop"/>
            <column name="description" value="High-performance laptop for business professionals"/>
            <column name="product_type" value="PHYSICAL"/>
            <column name="points_cost" value="50000"/>
            <column name="retail_price" value="1299.99"/>
            <column name="category" value="Electronics"/>
            <column name="brand" value="TechPro"/>
        </insert>
        <insert tableName="product">
            <column name="id" value="550e8400-e29b-41d4-a716-446655440022"/>
            <column name="sku" value="SOFTWARE-001"/>
            <column name="name" value="Productivity Software Suite"/>
            <column name="description" value="Complete productivity software package"/>
            <column name="product_type" value="VIRTUAL"/>
            <column name="points_cost" value="15000"/>
            <column name="retail_price" value="299.99"/>
            <column name="category" value="Software"/>
            <column name="brand" value="ProductivePro"/>
        </insert>

        <insert tableName="inventory">
            <column name="id" value="550e8400-e29b-41d4-a716-446655440031"/>
            <column name="product_id" value="550e8400-e29b-41d4-a716-446655440021"/>
            <column name="quantity_available" value="25"/>
            <column name="reorder_point" value="5"/>
        </insert>
        <insert tableName="inventory">
            <column name="id" value="550e8400-e29b-41d4-a716-446655440032"/>
            <column name="product_id" value="550e8400-e29b-41d4-a716-446655440022"/>
            <column name="quantity_available" value="1000"/>
            <column name="reorder_point" value="100"/>
        </insert>
    </changeSet>
</databaseChangeLog>